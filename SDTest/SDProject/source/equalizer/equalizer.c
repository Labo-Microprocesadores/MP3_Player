/*
 * equalizer.c
 *
 *  Created on: Mar 8, 2019
 *      Author: Grupo 2
 */
#include "arm_math.h"
#include "math_helper.h"
#include "equalizer.h"


/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

/* ----------------------------------------------------------------------
** Arm Biquad cascade filters for each band
** ------------------------------------------------------------------- */
static arm_biquad_cas_df1_32x64_ins_q31 S1;
static arm_biquad_cas_df1_32x64_ins_q31 S2;
static arm_biquad_casd_df1_inst_q31 S3;
static arm_biquad_casd_df1_inst_q31 S4;
static arm_biquad_casd_df1_inst_q31 S5;
static arm_biquad_casd_df1_inst_q31 S6;
static arm_biquad_casd_df1_inst_q31 S7;
static arm_biquad_casd_df1_inst_q31 S8;

/* ----------------------------------------------------------------------
** Q31 state buffers for Band1, Band2, Band3, Band4, Band5, Band6, Band7 and Band8
** ------------------------------------------------------------------- */

static q63_t biquadStateBandQ63[4 * 2][2];
static q31_t biquadStateBandQ31[4 * 2][6];



/* ----------------------------------------------------------------------
** Entire coefficient table.  There are 10 coefficients per 4th order Biquad
** cascade filter.  The first 10 coefficients correspond to the -10 dB gain
** setting of band 1; the next 10 coefficient correspond to the -9 dB gain
** setting of band 1; and so on.  There are 10*21=210 coefficients in total
** for band 1 (gains = -10,...0,...10).  After this come the 210 coefficients
** for band 2.
**
** The coefficients are in Q31 format
** ------------------------------------------------------------------- */

static const q31_t coeffTable[NUMBER_OF_BANDS * COEF_PER_FILTER * GAIN_LEVELS] = {
/*80Hz band*/
85654685,-1370084414,684430966,-4292704766,2145222356,2180803595,-4294967296,2115294774,-4173850207,2029811432,
769293490,-1537203818,767911737,-4292559548,2145077308,2180524311,-4294967296,2115557581,-4181752430,2037299895,
863127470,-1724690182,861564324,-4292400612,2144918576,2180163407,-4294967296,2115897387,-4189426026,2044597489,
968409910,-1935045064,966637008,-4292224729,2144742935,2179693227,-4294967296,2116340413,-4196939957,2051767985,
1086529833,-2171039573,1084511891,-4292027088,2144545591,2179073768,-4294967296,2116924671,-4204382440,2058894548,
1219044560,-2435778107,1216736074,-4291800119,2144318997,2178244456,-4294967296,2117707879,-4211875297,2066093843,
1367711749,-2732759584,1365050857,-4291530974,2144050349,2177107324,-4294967296,2118783699,-4219603890,2073545502,
9594861,-18942705,9351550,-4291195367,2143715446,2149660743,-4294967296,2145311775,-4227889279,2081563311,
2143935940,-4237492870,2094268642,-4237405908,2090810167,2147673777,-4290723817,2143056116,-4290738953,2143260175,
2145998687,-4250206071,2104737052,-4250180852,2103286271,2147581105,-4290000252,2142427334,-4289996142,2142519856,
2147483648,0,0,0,0,2147483648,0,0,0,0,
1920976642,-3801890716,1881441009,-4253147074,2106193462,2141008920,-4277061674,2136060093,-4289805572,2142330110,
1713834831,-3381731845,1668605623,-4244504921,2097734163,2140763559,-4277312007,2136553303,-4290343967,2142866395,
2095859005,-4188036757,2092181390,-4239680962,2093026691,1561823275,-3074862007,1513880691,-4290617516,2143139085,
2134064059,-4264713270,2130652214,-4290784607,2143305704,1368637624,-2689244525,1321515250,-4236526116,2089953626,
2133947361,-4264747509,2130802658,-4290896189,2143416991,1221389825,-2395520747,1175099051,-4234314478,2087801959,
2133849317,-4264777093,2130929913,-4290974661,2143495264,1090069565,-2134157968,1045101455,-4232702982,2086235529,
2133762931,-4264800817,2131039728,-4291031712,2143552175,972946235,-1901479871,929580972,-4231500067,2085067006,
2133684580,-4264818969,2131135990,-4291074138,2143594499,868478705,-1694274737,826869803,-4230587490,2084180949,
2133615017,-4264837835,2131224218,-4291106196,2143626481,775293807,-1509714295,735514793,-4229887276,2083501335,
2133547242,-4264846636,2131300624,-4291130709,2143650937,692169754,-1345301452,654242038,-4229345577,2082975720,
/*160Hz band*/
2109196191,-4184534346,2077207933,-4225625619,2081117295,2157355849,-4294967296,2138260690,-4269807780,2122733769,
2112297247,-4189530417,2079136275,-4228089422,2083493974,2157527231,-4294967296,2138078701,-4269960725,2122899328,
2115596821,-4194871540,2081212932,-4230459441,2085781976,2157697812,-4294967296,2137897353,-4270133304,2123084506,
2119087473,-4200540489,2083428223,-4232738918,2087984198,2157867254,-4294967296,2137716987,-4270324370,2123288140,
2122759245,-4206514941,2085769894,-4234931063,2090103523,2158035196,-4294967296,2137537964,-4270532751,2123509045,
2126596158,-4212760550,2088219692,-4237039040,2092142816,2158201256,-4294967296,2137360671,-4270757264,2123746023,
2130579360,-4219237195,2090756469,-4239065961,2094104908,2156487138,-4291230455,2135326060,-4270996721,2123997877,
2134686933,-4225898613,2093356004,-4241014873,2095992588,2154345480,-4286648882,2132874020,-4271249944,2124263416,
2138892540,-4232689723,2095989691,-4242888755,2097808594,2152110291,-4281888198,2130336264,-4271515774,2124541470,
2143168158,-4239552066,2098627232,-4244690510,2099555605,2149812240,-4277010388,2127744121,-4271793074,2124830894,
2147483648,-4245465459,2099085158,-4245465459,2099085158,2147483648,-4245465459,2099085158,-4245465459,2099085158,
1965148097,-3884288239,1921289462,-4248088841,2102853035,2093473160,-4164354944,2071390136,-4272377698,2125439432,
1798302402,-3552994243,1756704521,-4249690808,2104408474,2040813150,-4059339669,2019010563,-4272682922,2125756431,
1645638244,-3249932205,1606180128,-4251231423,2105904954,1989461595,-3956951074,1967950018,-4272995423,2126080576,
1505957634,-2972713553,1468524929,-4252713161,2107344797,1939376532,-3857105416,1918166706,-4273314258,2126410920,
1378164026,-2719152151,1342648624,-4254138408,2108730247,1890515616,-3759718174,1869618437,-4273638528,2126746558,
1261253990,-2487247670,1227553658,-4255509461,2110063471,1842835603,-3664703015,1822262104,-4273967382,2127086635,
1154309461,-2275170096,1122327481,-4256828530,2111346557,1796291727,-3571970546,1776053067,-4274300016,2127430344,
1056490531,-2081245344,1026135361,-4258097739,2112581517,1750837521,-3481427955,1730944967,-4274635672,2127776921,
967019524,-1903923703,938204746,-4259319125,2113770284,1706440795,-3393010782,1686905519,-4274973638,2128125653,
884979002,-1741382268,857629398,-4260494647,2114914719,1663456905,-3307425060,1644285463,-4275313246,2128475869,
/*320Hz band*/
2092086645,-4113867159,2029140168,-4152660395,2016887950,2163296568,-4285877309,2125173477,-4244122479,2098268180,
2096943944,-4121101087,2031652282,-4157601240,2021492400,2162441580,-4283527035,2123634427,-4244399806,2098595738,
2101981520,-4128588477,2034244584,-4162355873,2025930135,2161383048,-4280777839,2121899172,-4244715998,2098962110,
2107195446,-4136316549,2036908648,-4166930646,2030206197,2160129979,-4277649059,2119978075,-4245068828,2099365010,
2112578107,-4144265064,2039632293,-4171331850,2034325657,2158695145,-4274167559,2117885270,-4245456016,2099802101,
2118117274,-4152404531,2042398716,-4175565694,2038293588,2157095969,-4270369477,2115639517,-4245875253,2100271026,
2123796914,-4160697809,2045187293,-4179638287,2042115041,2155353603,-4266298395,2113263296,-4246324229,2100769423,
2129597468,-4169100680,2047973876,-4183555616,2045795021,2153492559,-4262004605,2110782441,-4246800643,2101294949,
2135495983,-4177562139,2050730949,-4187323538,2049338472,2151540495,-4257544673,2108225919,-4247302230,2101845298,
2141467152,-4186026456,2053428656,-4190947763,2052750258,2149527088,-4252979210,2105624724,-4247826771,2102418211,
2147483648,-4194909582,2051789600,-4194909582,2051789600,2147483648,-4194909582,2051789600,-4194909582,2051789600,
1966708857,-3838154527,1879950107,-4197787183,2059197805,2093751083,-4141541152,2049813236,-4248936131,2103623020,
1801162344,-3512040468,1718844886,-4201012999,2062242784,2041353982,-4037398528,1997971101,-4249516840,2104250744,
1649570824,-3213561738,1571459593,-4204116351,2065174512,1990249843,-3935859685,1947442975,-4250112292,2104892704,
1510766970,-2940399325,1436639555,-4207102124,2067997293,1940396426,-3836840557,1898186970,-4250720637,2105547028,
1383681054,-2690428467,1313326983,-4209975029,2070715299,1891751116,-3740256303,1850160798,-4251340113,2106211931,
1267333097,-2461702987,1200553139,-4212739605,2073332571,1844270401,-3646020250,1803321235,-4251969048,2106885725,
1160814717,-2252419674,1097420804,-4215400222,2075853012,1797926169,-3554076112,1757640060,-4252605859,2107566811,
1063234851,-2060812817,1003052818,-4217961080,2078280393,1752788937,-3464562466,1713185369,-4253249057,2108253684,
973901920,-1885507177,916763828,-4220426217,2080618352,1708728391,-3377220804,1669828836,-4253897238,2108944930,
892128734,-1725138938,837875387,-4222799508,2082870393,1665697779,-3291957727,1627523754,-4254549087,2109639223,
/*640Hz band*/
2058047289,-3965855273,1936293510,-3997035303,1894879842,2158337438,-4231038421,2082959201,-4191210286,2050173195,
2066353944,-3977229066,1939918470,-4006911869,1903505131,2157923790,-4229026685,2081188547,-4191653206,2050815239,
2074816138,-3988687761,1943499943,-4016424708,1911837539,2157324141,-4226659802,2079245541,-4192172209,2051533252,
2083435561,-4000224043,1947030634,-4025585782,1919884407,2156545271,-4223953916,2077139670,-4192763092,2052322794,
2092209681,-4011821987,1950498931,-4034406976,1927653295,2155598347,-4220933896,2074884785,-4193421539,2053179332,
2101131984,-4023457553,1953889169,-4042900050,1935151924,2154498568,-4217632646,2072498759,-4194143172,2054098285,
2110191991,-4035098659,1957181694,-4051076599,1942388119,2153265045,-4214090847,2070003352,-4194923599,2055075069,
2119375647,-4046705972,1960353273,-4058948015,1949369760,2151920300,-4210355966,2067423718,-4195758446,2056105135,
2128665719,-4058233709,1963377518,-4066525462,1956104741,2150489760,-4206481265,2064787912,-4196643394,2057184001,
2138042320,-4069630693,1966225426,-4073819847,1962600927,2149001143,-4202524585,2062126286,-4197574205,2058307280,
2147483648,-4090870419,1960452911,-4090870419,1960452911,2147483648,-4090870419,1960452911,-4090870419,1960452911,
1969858562,-3736861471,1800268068,-4087601673,1974908032,2094264225,-4093548977,2007297846,-4199557014,2060670137,
1806940780,-3421665490,1645910286,-4094109494,1980734259,2042352484,-3991194563,1956473503,-4200601137,2061901601,
1657526021,-3132881574,1504612668,-4100374993,1986352257,1991704870,-3891397515,1906954968,-4201675400,2063161274,
1520507450,-2868330176,1375291313,-4106407581,1991769329,1942278260,-3794072619,1858699894,-4202776247,2064445508,
1394868348,-2626009898,1256951209,-4112216353,1996992608,1894029327,-3699134184,1811665665,-4203900284,2065750826,
1279656324,-2404048295,1148662404,-4117810081,2002029050,1846941185,-3606548042,1765834851,-4205044291,2067073930,
1174012442,-2200756127,1049585725,-4123197224,2006885419,1800976768,-3516240475,1721170578,-4206205214,2068411702,
1077152717,-2014591725,958955381,-4128385926,2011568289,1756091580,-3428123108,1677628732,-4207380170,2069761199,
988319862,-1844070193,876035508,-4133384026,2016084033,1712304991,-3342232063,1635226034,-4208566444,2071119653,
906872176,-1687929082,800198785,-4138199057,2020438827,1669547161,-3258429111,1593893784,-4209761487,2072484471,

/*1280Hz band*/
402829011,-738208125,356910248,-4079438059,1957216387,2245432021,-4294967296,2091515604,-3654646021,1676533201,
2006242366,-3667450384,1769978317,-3673983539,1691572412,2150436377,-4111298134,2000387266,-4079896293,1958456964,
2021281307,-3685430369,1775355122,-3692647885,1706170611,2150585615,-4109640333,1997895092,-4080499890,1959843037,
2036480524,-3703209565,1780480609,-3710659035,1720333486,2150585098,-4107723534,1995282088,-4081241354,1961366212,
2051846735,-3720776288,1785343513,-3728037013,1734067606,2150442345,-4105567564,1992561066,-4082112962,1963017918,
2067382963,-3738110967,1789928695,-3744801801,1747380301,2150168880,-4103200153,1989748824,-4083106849,1964789500,
2083088601,-3755186318,1794217293,-3760973246,1760279550,2149780017,-4100656499,1986865926,-4084215093,1966672292,
392187654,-704786875,335988709,-4085429786,1968657696,2252610501,-4294967296,2079303626,-3776570988,1772773869,
387253310,-693656559,329910858,-4086743095,1970737236,2253543253,-4294967296,2077614006,-3791614393,1784872215,
2049198948,-3903955111,1886955697,-4088147313,1972902613,2234047317,-3988137217,1892203796,-3806122497,1796583891,
2147483648,-3872577823,1790396860,-3872577823,1790396860,2147483648,-3872577823,1790396860,-3872577823,1790396860,
2055260778,-3912583378,1888177059,-4091198550,1977458806,2014540657,-3570499138,1685363842,-3833607013,1818885697,
1401558811,-2667219747,1286204968,-3846619462,1829495463,2432571216,-4294967296,2021821577,-4092831157,1979834245,
1373036975,-2612101918,1258700997,-3859168627,1839757708,2430732788,-4274693750,2006599480,-4094525899,1982264815,
1540291530,-2697573619,1262567789,-3871271346,1849682388,1945426248,-3699930032,1781627488,-4096276229,1984743580,
1417634384,-2472083920,1153511180,-3882943954,1859279424,1897849279,-3608465842,1736392424,-4098075883,1987263932,
1304825609,-2265180538,1053631222,-3894202281,1868558667,1851374467,-3519244357,1692344086,-4099918899,1989819591,
1201081380,-2075360843,962177532,-3905061645,1877529861,1805968350,-3432199693,1649449254,-4101799612,1992404607,
1105674141,-1901232301,878455455,-3915536856,1886202618,1761606134,-3347282128,1607682330,-4103712660,1995013364,
1017932720,-1741511774,801825387,-3925642216,1894586396,1718265985,-3264447218,1567020074,-4105652977,1997640567,
1161567120,-2206555156,1058652160,-3935391528,1902690472,1352263437,-2301318659,1055707479,-4107615795,2000281245,

/*2500Hz band*/
419020851,-672701607,333042934,-3845598234,1791228460,2383641552,-4294967296,2076328658,-2933323795,1350253326,
421099828,-672404799,332028540,-3845029762,1793545284,2385063067,-4294967296,2072160899,-2967592626,1372492837,
1467247749,-2640650185,1271448819,-3844719184,1796123670,2704872053,-4294967296,2115096526,-3000814395,1394281552,
1539494672,-2769110598,1330610473,-3844654782,1798948707,2717177836,-4289463168,2106476289,-3033012288,1415609794,
1615001796,-2903341001,1392293649,-3844824380,1802005196,2626817304,-4121796038,2018272197,-3064210260,1436470170,
1693948789,-3043669560,1456643902,-3845215500,1805277800,2539709153,-3960114962,1933284176,-3094432843,1456857396,
1776527161,-3190447503,1523817817,-3845815495,1808751186,2455685544,-3804121367,1851359530,-3123704976,1476768121,
1862942272,-3344052982,1593984928,-3846611675,1812410138,2374590465,-3653538523,1772357226,-3152051847,1496200756,
1953413775,-3504892152,1667328317,-3847591404,1816239663,2296279546,-3508110978,1696147547,-3179498751,1515155305,
2048176838,-3673401688,1744045920,-3848742202,1820225077,2220618845,-3367602435,1622610979,-3206070971,1533633196,
2147483648,-3427745204,1509822168,-3427745204,1509822168,2147483648,-3427745204,1509822168,-3427745204,1509822168,
2056285858,-3685296588,1742925069,-3851508282,1828606800,2026723494,-3025782929,1447391897,-3256691791,1569170933,
1969049945,-3527896313,1665328913,-3853099984,1832975861,1912686211,-2831864831,1349494168,-3280789996,1586239415,
1885683495,-3377670491,1591458862,-3854815688,1837446398,1804939068,-2649268845,1257542148,-3304112582,1602848246,
1806087568,-3234427215,1521205078,-3856644578,1842006088,1703083941,-2477286282,1171166110,-3326683439,1619003836,
1730153735,-3097957912,1454450250,-3858576276,1846643170,1606758133,-2315270313,1090028076,-3348525997,1634713231,
1657770408,-2968048715,1391075034,-3860600860,1851346451,1515626538,-2162623400,1013815548,-3369663196,1649984007,
1588818817,-2844473282,1330954747,-3862708872,1856105307,1429383729,-2018799267,942242148,-3390117456,1664824189,
1523177015,-2726999992,1273962804,-3864891321,1860909685,1347748630,-1883294196,875043241,-3409910656,1679242165,
1143674039,-2047727219,955178952,-3429064119,1693246619,1622656984,-2242338331,1037067309,-3867139684,1865750096,
1116680980,-1999692249,931430027,-3447598604,1706846458,1502475551,-2052284444,944697582,-3869445902,1870617600,
/*5000Hz band*/
1333578742,-2000928677,1017800776,-3285881763,1492335885,2693051259,-2759313035,1789730084,-1422324807,981330176,
1399519169,-2100522561,1062371008,-3279647981,1496899567,2632084224,-2659990634,1725733360,-1471026936,1005694117,
1468423489,-2204729626,1108667135,-3273828922,1501903077,2572727221,-2562999854,1663398992,-1518613962,1030014770,
1540448385,-2313812364,1156785538,-3268410094,1507320752,2514900006,-2468238294,1602667709,-1565094332,1054250893,
1615760892,-2428052501,1206830950,-3263376164,1513126602,2458528865,-2375612872,1543486709,-1610478450,1078364364,
1694538925,-2547752232,1258917101,-3258711193,1519294546,2403546318,-2285039273,1485809290,-1654778420,1102320150,
1776971797,-2673235484,1313167383,-3254398836,1525798619,2349890829,-2196441420,1429594496,-1698007798,1126086241,
1863261001,-2804849615,1369715759,-3250422529,1532613148,2297506215,-2109750658,1374806575,-1740181375,1149633562,
1953621058,-2942967278,1428707769,-3246765649,1539712911,2246341086,-2024905002,1321414474,-1781314972,1172935859,
2048280592,-3087988669,1490301739,-3243411652,1547073255,2196348180,-1941848338,1269391296,-1821425264,1195969582,
2147483648,-2449822683,1089559289,-2449822683,1089559289,2147483648,-2449822683,1089559289,-2449822683,1089559289,
2056181720,-3105515497,1481298239,-3237547237,1562480564,2049119706,-1737996192,1141189057,-1898645939,1241149775,
1968840734,-2976676665,1411628676,-3235005111,1570481932,1955207470,-1621823916,1067916376,-1935792569,1263261396,
1885360650,-2853674224,1345541571,-3232702601,1578652799,1865497343,-1511677974,998675057,-1971988153,1285034451,
1805634925,-2736345026,1282913273,-3230624987,1586972560,1779759397,-1407249521,933260922,-2007251560,1306456779,
1729551239,-2624517298,1223617124,-3228758088,1595421533,1697782233,-1308253688,871484897,-2041601793,1327518064,
1656991966,-2518011297,1167523965,-3227088283,1603980976,1619372112,-1214427822,813171816,-2075057921,1348209702,
1587835499,-2416641253,1114503201,-3225602535,1612633082,1544351243,-1125529118,758158824,-2107639017,1368524669,
1521956246,-2320215281,1064422898,-3224288399,1621360978,1472557393,-1041333292,706294489,-2139364108,1388457395,
1459228781,-2228541638,1017152766,-3223134026,1630148711,1403839448,-961630439,657436007,-2170252129,1408003641,
1399522403,-2141420330,972560376,-3222128157,1638981227,1338062266,-886227541,611450932,-2200321885,1427160391,
/*10000Hz band*/
6737660040,1208411644,515498770,3841369181,1738632699,2649115632,-2706139492,1005221758,-3029215440,1183777771,
823016174,1346241193,573829970,3812089187,1715210489,2607524698,-2647840151,984314826,-2951139769,1141056229,
917983745,1498662638,638125898,3779970515,1689933872,2564579612,-2583870667,961589900,-2866076800,1096479690,
1023593520,1666755241,708718606,3744317731,1662390969,2520245805,-2512691634,936631883,-2772362719,1049722900,
1140970732,1851382903,785779728,3704085499,1631969410,2474458507,-2431972143,908849427,-2667494682,1000301670,
1271333933,2052896148,869149347,3657606316,1597709802,2427100534,-2337974667,877368759,-2547482339,947477862,
1415983573,2270472505,957974625,3601997122,1557999169,2377961377,-2224211712,840838034,-2405439355,890087946,
1576265545,2500446991,1049847635,3531653175,1509835723,2326652685,-2078025631,797045519,-2228019656,826220226,
1753463014,2731023555,1138306574,3433403325,1446665731,2272400597,-1869530917,742198735,-1983976245,752669693,
1948401422,2916339335,1202634489,3262169102,1349382160,2213357408,-1495382184,671542164,-1566476412,666319272,
2147483648,0,0,0,0,2147483648,0,0,0,0,
2114595284,3212209511,1328716591,3214322759,1325516329,2078558331,-1516199018,644933187,-1450876743,651555782,
2094190540,3348198142,1410764497,3344711797,1394095419,2024518570,-1870373613,709571769,-1766760262,701399062,
2076280332,3414555466,1459774662,3406576413,1430298744,1977299841,-2051453530,760743916,-1918002670,735667266,
2059958416,3455190121,1494499622,3443403351,1452866320,1934630353,-2167018126,801864619,-2008635769,759341992,
2044832755,3482770733,1521338399,3467665569,1468130410,1895458430,-2248513920,836283388,-2068625629,776290490,
2030689018,3502632372,1543211917,3484589391,1478959161,1859179672,-2309378185,866009170,-2110611431,788754097,
2017394040,3517495595,1561687157,3496827162,1486880863,1825401069,-2356559909,892284002,-2141046792,798097411,
2004857497,3528921969,1577696108,3505893787,1492798688,1793844432,-2394102472,915915699,-2163637260,805199642,
1993013793,3537883204,1591834316,3512726772,1497285856,1764299688,-2424556283,937453075,-2180686315,810653872,
1981812423,3545020317,1604502966,3517940657,1500725429,1736599785,-2449627445,957282364,-2193709568,814874693

};
/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

/**
 * @brief Initialize equalizer.
 * 
 */
void equalizer_init(void)
{
    /* Initialize the state and coefficient buffers for all Biquad sections all gains set to 0 on setup*/

  arm_biquad_cas_df1_32x64_init_q31(&S1, NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*0 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
            &biquadStateBandQ63[0][0], 0);

  arm_biquad_cas_df1_32x64_init_q31(&S2, NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*1 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
            &biquadStateBandQ63[0][1], 0);

  arm_biquad_cascade_df1_init_q31(&S3, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*2 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][0], 0);

  arm_biquad_cascade_df1_init_q31(&S4, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*3 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][1], 0);

  arm_biquad_cascade_df1_init_q31(&S5, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*4 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][2], 0);

arm_biquad_cascade_df1_init_q31(&S6, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*5 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][3], 0);

  arm_biquad_cascade_df1_init_q31(&S7, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*6 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][4], 0);

  arm_biquad_cascade_df1_init_q31(&S8, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*7 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][5], 0);

  
}

/**
 * @brief Sets  equalizer filter gains.
 * @param gain  number in dB with the desired gain of the filter
 * @param band selected band in which to change gain (between 1 and NUMBER_OF_BANDS)
 */
void equalizer_set_band_gain (int32_t band, int32_t gain)
{
    if(band < 3 )
    {
         arm_biquad_cas_df1_32x64_init_q31(&S1, NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*0 + COEF_PER_FILTER*(gain + MAX_GAIN)],
            &biquadStateBandQ63[0][band - 1], 0);
    }
    else
    {
         arm_biquad_cascade_df1_init_q31(&S7, NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*6 + COEF_PER_FILTER*(gain + MAX_GAIN)],
          &biquadStateBandQ31[0][band - 3], 0);
    }
}

/**
 * @brief Applies the filter to the data in inputF32 and stores the result in outputF32
 * @param inputF32  pointer to an array of size FRAME_SIZE with input data
 * @param outputF32 pointer to an array of size FRAME_SIZE //!(will be overwritten)
 */
void equalizer_equalize(float32_t* inputF32, float32_t * outputF32)
{
    
    /* ----------------------------------------------------------------------
    ** Q31 input and output buffers
    ** ------------------------------------------------------------------- */

    q31_t inputQ31[BLOCKSIZE];
    q31_t outputQ31[BLOCKSIZE];

    for(int i=0; i < NUMBER_OF_BLOCKS; i++)
  {

    /* ----------------------------------------------------------------------
    ** Convert block of input data from float to Q31
    ** ------------------------------------------------------------------- */

    arm_float_to_q31(inputF32 + (i*BLOCKSIZE), inputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Scale down by 1/8.  This provides additional headroom so that the
    ** graphic EQ can apply gain.
    ** ------------------------------------------------------------------- */

    arm_scale_q31(inputQ31, 0x7FFFFFFF, -3, inputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 32x64 process function for band1, band2
    ** ------------------------------------------------------------------- */

    arm_biquad_cas_df1_32x64_q31(&S1, inputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cas_df1_32x64_q31(&S2, outputQ31, outputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 process function for band3, band4, band5, band6, band7, band8
    ** ------------------------------------------------------------------- */

    arm_biquad_cascade_df1_fast_q31(&S3, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S4, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S5, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S6, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S7, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S8, outputQ31, outputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Convert Q31 result back to float
    ** ------------------------------------------------------------------- */

    arm_q31_to_float(outputQ31, outputF32 + (i * BLOCKSIZE), BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Scale back up
    ** ------------------------------------------------------------------- */

    arm_scale_f32(outputF32 + (i * BLOCKSIZE), 8.0f, outputF32 + (i * BLOCKSIZE), BLOCKSIZE);
  };
}
